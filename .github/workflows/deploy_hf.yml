# .github/workflows/deploy-to-hf.yml

name: Deploy to Hugging Face Hub

on:
  push:
    branches:
      - main

# Variables d'environnement globales, accessibles à tous les jobs
env:
  HF_MODEL_REPO: ${{ github.repository }}
  MODEL_FILENAME: model.joblib
  PYTHON_VERSION: '3.9'

jobs:
  # --- JOB 1: Entraînement et Déploiement ---
  deploy:
    name: Train and Deploy Model
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Nécessaire pour que Git LFS fonctionne correctement s'il est utilisé
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        run: python model.py --action train
      
      - name: Push to Hugging Face Hub
        env:
          # Le token est passé en variable d'environnement uniquement pour cette étape
          HUGGING_FACE_HUB_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os

          # Le script peut maintenant lire correctement les variables
          repo_id = os.getenv('HF_MODEL_REPO')
          model_filename = os.getenv('MODEL_FILENAME')
          
          print(f'Déploiement sur le dépôt : {repo_id}')
          print(f'Fichier modèle à pousser : {model_filename}')

          api = HfApi()

          api.upload_file(
              path_or_fileobj=f'./{model_filename}',
              path_in_repo=model_filename,
              repo_id=repo_id,
              repo_type='model'
          )
          
          api.upload_file(
              path_or_fileobj='./README.md',
              path_in_repo='README.md',
              repo_id=repo_id,
              repo_type='model'
          )
          
          print('Fichiers poussés avec succès sur le Hub !')
          "
  notify_on_success:
    name: Send Success Notification
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Send deployment success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER_ADDRESS }}
          server_port: ${{ secrets.MAIL_SERVER_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}

          subject: 'Succès du Déploiement : ${{ env.HF_MODEL_REPO }}'
          to: ${{ secrets.MAIL_USERNAME }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Bonjour,

            Le déploiement du modèle sur le dépôt ${{ env.HF_MODEL_REPO }} a réussi.
            
            Commit : ${{ github.sha }}
            Auteur : ${{ github.actor }}
            
            Le modèle est maintenant disponible sur Hugging Face Hub :
            https://huggingface.co/${{ env.HF_MODEL_REPO }}

            Cordialement,
            Votre Pipeline CI/CD.